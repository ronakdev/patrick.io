<DOCTYPE html>
	<!DOCTYPE html>
	<html>
	<head>
		<title></title>
		<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.2/css/bootstrap.min.css" rel="stylesheet" />
		<style>
			@import url('https://fonts.googleapis.com/css?family=Roboto|Roboto+Condensed');
			h1,h3 {
				font-family: 'Roboto Condensed', sans-serif;
			},
			body {
				font-family: 'Roboto', sans-serif;
			}
			.slidecontainer {
    width: 100%;
}

.slider {
    -webkit-appearance: none;
    width: 100%;
    height: 25px;
    background: #d3d3d3;
    outline: none;
    opacity: 0.7;
    -webkit-transition: .2s;
    transition: opacity .2s;
}

.slider:hover {
    opacity: 1;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 25px;
    height: 25px;
    background: #4CAF50;
    cursor: pointer;
}

.slider::-moz-range-thumb {
    width: 25px;
    height: 25px;
    background: #4CAF50;
    cursor: pointer;
}
		</style>
	</head>

	<body>
	    <div class="container">
		    <div class="row">
		        <img src="https://i.imgur.com/GX4CEzf.png">
		    </div>
		    <br/>
		    <div class="row">
		        <div class="col-12 center">
		            <center>
		                <canvas id="smoothie-chart" width = "1000" height="400"></canvas>
		            </center>
		        </div>
		        <button id = "myButton" onclick="myJS()">Begin Relaxing</button> <h4>Range: <span id="rangeLabel">200</span></h4>
		    </div>
		    <br/>
		    <br/>
		    <div class="row">
	    	  <input type="range" min="0" max="400" value="200" class="slider" id="myRange" onchange="delta = this.value ; document.getElementById('rangeLabel').innerHTML = this.value">
	    	</div>
		    <div class="row">
		        <div class="col-4 col-md-4">
		            <h3>Step 1</h3>
		            <p>Have the patient don the head set with the band portion snugly contacting the skin of the forehead. When ready to begin, click the “begin relaxing” button.  Visually confirm with the data output that the headset is streaming to the computer, ensuring that power is on and bluetooth is enabled.
		            </p>
		        </div>
		        <div class="col-4 col-md-4">
		            <h3>Step 2</h3>
		            <p>Bring the patient to a reasonable resting state and visually identify an approximate homeostatic home-base.  Once the data levels out, click the “establish baseline” button to set the value,  Adjust the slider to widen or tighten the target tolerance region.

		            </p>
		        </div>
		        <div class="col-4 col-md-4">
		            <h3>Step 3</h3>
		            <p>Adjust patient CI electrodes, slowly monitoring the data trend which follows.  When electrode settings which stabilize the data within the desired tolerance zone are achieved, remove the headset and lock in the new CI calibration.
		            </p>
		        </div>
		    </div>
		</div>
	</body>

	<script src="/socket.io/socket.io.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/smoothie/1.34.0/smoothie.min.js"></script>
	<script>
		var smoothie = new SmoothieChart({maxValue: 1000, minValue: -1000, grid:{strokeStyle:'#009bff'}}),
	    canvas = document.getElementById('smoothie-chart')


		var EEG1 = new TimeSeries();
		var TopConstant = new TimeSeries();
		var BottomConstant = new TimeSeries();
		let timeElapsed = -1
		let socket = io();
		let baseline = 0 // updated
		var delta = 200 // this is arbitrary
		let x = 0
		let ave = -1
		let b1Avg = 0
		let b2Avg = 0

		let measuring = false
		function myJS(){
			if (x == 0) {
				measuring = true
				x = 1
				document.getElementById('myButton').innerHTML = "Establish Baseline with current data"
			} else if (x == 1) {
				measuring = false
				// get b1 and b2 avg

				ave = ((b1Avg+b2Avg)/2) 
				x = 2
				document.getElementById('myButton').style.display = 'none' // hide button
			}
		}

		socket.on('eeg-data', function(data){
			// data is broken into time and b1 and b2 (time, temple, forehead respectively)

			/* if (timeElapsed == -1) {
				// this the first time
				timeElapsed = time	
			} else {
				// 99         100    99
				timeElapsed += (time - timeElapsed)
			} */
			if (measuring) {
				b1Avg = (b1Avg + data[1]) / 2
				b2Avg = (b2Avg + data[2]) / 2
			}
			



			EEG1.append(new Date().getTime(), ((data[1]+data[2])/2) - 1000)

	    });

		setInterval(function() {
		  // EEG1.append(new Date().getTime(), () => {
		  // 	// do socket magic

		  // 	return 30
		  // });

		  // console.log("in setInterval")
		  console.log(`average: ${ave}`)
		  if (ave !=-1){
		  	console.log(`Ave: ${ave}, delta: ${delta}`)
		  	let top = ave+delta - 1000
		  	let bottom = ave-delta - 1000
		  	console.log(`top: ${top}, bottom: ${bottom}`)
		  	TopConstant.append(new Date().getTime(), top) // what is this
		  	BottomConstant.append(new Date().getTime(), bottom)
		  } else {
		  	console.log('else')
		  }
		  console.log("end of setInterval")
		  
		}, 500);

		smoothie.addTimeSeries(EEG1, {lineWidth:3.4,strokeStyle:'#c2f3ff'});
		smoothie.addTimeSeries(TopConstant, {lineWidth: 3.4, strokeStyle: '#7841e5'}) ;
		smoothie.addTimeSeries(BottomConstant, {lineWidth: 3.4, strokeStyle: 'red'}) ;
		smoothie.streamTo(canvas, 500) ; 

	</script>

</html>	

